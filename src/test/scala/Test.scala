package jp.co.guru.PostgreSQLAnalyze

import Parse._
import org.scalatest.FunSuite
import com.typesafe.scalalogging.slf4j.Logging

class StringFunSuite extends FunSuite with Logging {
  test("first test") {
    val plan = new ResultIterator(Data.orgSecond).toList
    plan.foreach(p => println(p.excel(plan(0)).mkString("\t")))
  }
}

object Test {
  def main(args: Array[String]) {
    val ri = new ResultIterator(Data.orgSecond).toList
    //    ri.foreach(p => logger.debug(p.toString))
    println(ri(0).excelHeader)
    ri.foreach(p => println(p.excel(ri(0)).mkString("\t")))
  }

  val test = """
"Limit  (cost=216264.37..216265.27 rows=20 width=484) (actual time=7587.633..7587.773 rows=20 loops=1)"
"  ->  Unique  (cost=216264.37..216654.61 rows=8672 width=484) (actual time=7587.628..7587.709 rows=20 loops=1)"
"        ->  Sort  (cost=216264.37..216286.05 rows=8672 width=484) (actual time=7587.624..7587.649 rows=20 loops=1)"
"              Sort Key: public.payoffs.closedate, public.contracts.contract_cd, (COALESCE(sum(sales.salequantity), 0::numeric)), (COALESCE(sum(sales.saleprice), 0::numeric)), (COALESCE(sum(sales.netprofit), 0::numeric)), (COALESCE(sum(commshop.commissionprice), 0::numeric)), (COALESCE(sum(commdelivery.commissionprice), 0::numeric)), (COALESCE(sum(commpickup.commissionprice), 0::numeric)), (COALESCE(sum(commpricetag.commissionprice), 0::numeric)), (COALESCE(sum(commbox.commissionprice), 0::numeric)), (COALESCE(sum(commpaperwork.commissionprice), 0::numeric)), (COALESCE((sum(payoffothers.price)), 0::numeric)), public.payoffs.id, public.contracts.id, public.contracts.contractorname, public.contracts.contractorkname, public.organizations.name"
"              Sort Method: quicksort  Memory: 94kB"
"              ->  Hash Left Join  (cost=215393.54..215697.13 rows=8672 width=484) (actual time=7583.461..7585.911 rows=260 loops=1)"
"                    Hash Cond: (public.contracts.organization_id = public.organizations.id)"
"                    ->  Hash Left Join  (cost=215391.98..215576.32 rows=8672 width=380) (actual time=7583.340..7585.089 rows=260 loops=1)"
"                          Hash Cond: (sales.payoff_id = public.payoffs.id)"
"                          ->  Merge Left Join  (cost=215364.70..215429.80 rows=8672 width=376) (actual time=7581.181..7582.222 rows=260 loops=1)"
"                                Merge Cond: ((sales.payoff_id = payoffothers.payoff_id) AND (public.contracts.id = payoffothers.contract_id))"
"                                ->  Sort  (cost=215363.34..215385.02 rows=8672 width=344) (actual time=7581.074..7581.378 rows=260 loops=1)"
"                                      Sort Key: sales.payoff_id, public.contracts.id"
"                                      Sort Method: quicksort  Memory: 65kB"
"                                      ->  Hash Left Join  (cost=214497.20..214796.10 rows=8672 width=344) (actual time=7579.027..7580.422 rows=260 loops=1)"
"                                            Hash Cond: ((sales.contract_cd)::text = (public.contracts.contract_cd)::text)"
"                                            ->  HashAggregate  (cost=214382.14..214468.86 rows=8672 width=51) (actual time=7573.112..7573.748 rows=260 loops=1)"
"                                                  ->  Hash Left Join  (cost=175511.76..214121.98 rows=8672 width=51) (actual time=6324.866..7451.636 rows=26707 loops=1)"
"                                                        Hash Cond: (sales.id = commpaperwork.sale_id)"
"                                                        ->  Hash Right Join  (cost=139332.64..175656.42 rows=8672 width=51) (actual time=4981.575..6003.047 rows=26707 loops=1)"
"                                                              Hash Cond: (commbox.sale_id = sales.id)"
"                                                              ->  Seq Scan on salecommissions commbox  (cost=0.00..31655.24 rows=366545 width=8) (actual time=0.253..781.727 rows=364872 loops=1)"
"                                                                    Filter: (((isexempt IS NULL) OR (isexempt = 0)) AND (commissiondiv_id = 31))"
"                                                                    Rows Removed by Filter: 1054011"
"                                                              ->  Hash  (cost=139224.60..139224.60 rows=8643 width=47) (actual time=4296.531..4296.531 rows=26707 loops=1)"
"                                                                    Buckets: 1024  Batches: 1  Memory Usage: 2136kB"
"                                                                    ->  Nested Loop Left Join  (cost=53408.42..139224.60 rows=8643 width=47) (actual time=3035.202..4246.723 rows=26707 loops=1)"
"                                                                          Join Filter: (sales.id = commpickup.sale_id)"
"                                                                          ->  Nested Loop Left Join  (cost=53408.42..112878.97 rows=8643 width=43) (actual time=2993.288..4076.145 rows=26707 loops=1)"
"                                                                                Join Filter: (sales.id = commdelivery.sale_id)"
"                                                                                ->  Hash Right Join  (cost=53408.42..86533.33 rows=8643 width=39) (actual time=2951.417..3906.667 rows=26707 loops=1)"
"                                                                                      Hash Cond: (commshop.sale_id = sales.id)"
"                                                                                      ->  Seq Scan on salecommissions commshop  (cost=0.00..31655.24 rows=368862 width=8) (actual time=0.235..773.846 rows=364872 loops=1)"
"                                                                                            Filter: (((isexempt IS NULL) OR (isexempt = 0)) AND (commissiondiv_id = 27))"
"                                                                                            Rows Removed by Filter: 1054011"
"                                                                                      ->  Hash  (cost=53301.42..53301.42 rows=8560 width=35) (actual time=2289.331..2289.331 rows=26707 loops=1)"
"                                                                                            Buckets: 1024  Batches: 1  Memory Usage: 1797kB"
"                                                                                            ->  Nested Loop  (cost=20278.04..53301.42 rows=8560 width=35) (actual time=1327.525..2241.801 rows=26707 loops=1)"
"                                                                                                  ->  Seq Scan on organizations  (cost=0.00..1.31 rows=1 width=4) (actual time=0.017..0.025 rows=1 loops=1)"
"                                                                                                        Filter: (id = 7)"
"                                                                                                        Rows Removed by Filter: 24"
"                                                                                                  ->  Hash Right Join  (cost=20278.04..53214.51 rows=8560 width=39) (actual time=1327.498..2177.527 rows=26707 loops=1)"
"                                                                                                        Hash Cond: (commpricetag.sale_id = sales.id)"
"                                                                                                        ->  Seq Scan on salecommissions commpricetag  (cost=0.00..31655.24 rows=321566 width=8) (actual time=0.063..714.728 rows=324267 loops=1)"
"                                                                                                              Filter: (((isexempt IS NULL) OR (isexempt = 0)) AND (commissiondiv_id = 30))"
"                                                                                                              Rows Removed by Filter: 1094616"
"                                                                                                        ->  Hash  (cost=20171.04..20171.04 rows=8560 width=35) (actual time=730.705..730.705 rows=26707 loops=1)"
"                                                                                                              Buckets: 1024  Batches: 1  Memory Usage: 1774kB"
"                                                                                                              ->  Hash Join  (cost=132.13..20171.04 rows=8560 width=35) (actual time=4.688..684.201 rows=26707 loops=1)"
"                                                                                                                    Hash Cond: ((sales.contract_cd)::text = (public.contracts.contract_cd)::text)"
"                                                                                                                    ->  Hash Join  (cost=25.08..19843.56 rows=26965 width=27) (actual time=2.166..547.513 rows=75304 loops=1)"
"                                                                                                                          Hash Cond: (sales.payoff_id = public.payoffs.id)"
"                                                                                                                          ->  Seq Scan on sales  (cost=0.00..19056.00 rows=131423 width=27) (actual time=0.854..258.039 rows=131510 loops=1)"
"                                                                                                                                Filter: (payoff_id IS NOT NULL)"
"                                                                                                                                Rows Removed by Filter: 233790"
"                                                                                                                          ->  Hash  (cost=19.60..19.60 rows=438 width=4) (actual time=1.274..1.274 rows=438 loops=1)"
"                                                                                                                                Buckets: 1024  Batches: 1  Memory Usage: 16kB"
"                                                                                                                                ->  Seq Scan on payoffs  (cost=0.00..19.60 rows=438 width=4) (actual time=0.070..0.666 rows=438 loops=1)"
"                                                                                                                                      Filter: (closedate >= '2013-10-31'::date)"
"                                                                                                                                      Rows Removed by Filter: 330"
"                                                                                                                    ->  Hash  (cost=98.68..98.68 rows=670 width=12) (actual time=2.487..2.487 rows=626 loops=1)"
"                                                                                                                          Buckets: 1024  Batches: 1  Memory Usage: 30kB"
"                                                                                                                          ->  Seq Scan on contracts  (cost=0.00..98.68 rows=670 width=12) (actual time=0.016..1.540 rows=626 loops=1)"
"                                                                                                                                Filter: (((status IS NULL) OR (status = 0)) AND (organization_id = 7))"
"                                                                                                                                Rows Removed by Filter: 1486"
"                                                                                ->  Materialize  (cost=0.00..26215.99 rows=1 width=8) (actual time=0.003..0.003 rows=0 loops=26707)"
"                                                                                      ->  Index Scan using salecommissions_sale_id_commissiondiv_id_key on salecommissions commdelivery  (cost=0.00..26215.99 rows=1 width=8) (actual time=41.824..41.824 rows=0 loops=1)"
"                                                                                            Index Cond: (commissiondiv_id = 28)"
"                                                                                            Filter: ((isexempt IS NULL) OR (isexempt = 0))"
"                                                                          ->  Materialize  (cost=0.00..26215.99 rows=1 width=8) (actual time=0.003..0.003 rows=0 loops=26707)"
"                                                                                ->  Index Scan using salecommissions_sale_id_commissiondiv_id_key on salecommissions commpickup  (cost=0.00..26215.99 rows=1 width=8) (actual time=41.876..41.876 rows=0 loops=1)"
"                                                                                      Index Cond: (commissiondiv_id = 29)"
"                                                                                      Filter: ((isexempt IS NULL) OR (isexempt = 0))"
"                                                        ->  Hash  (cost=31655.24..31655.24 rows=361910 width=8) (actual time=1342.580..1342.580 rows=364872 loops=1)"
"                                                              Buckets: 65536  Batches: 1  Memory Usage: 15678kB"
"                                                              ->  Seq Scan on salecommissions commpaperwork  (cost=0.00..31655.24 rows=361910 width=8) (actual time=0.057..784.021 rows=364872 loops=1)"
"                                                                    Filter: (((isexempt IS NULL) OR (isexempt = 0)) AND (commissiondiv_id = 37))"
"                                                                    Rows Removed by Filter: 1054011"
"                                            ->  Hash  (cost=93.40..93.40 rows=1733 width=52) (actual time=5.856..5.856 rows=1733 loops=1)"
"                                                  Buckets: 1024  Batches: 1  Memory Usage: 148kB"
"                                                  ->  Seq Scan on contracts  (cost=0.00..93.40 rows=1733 width=52) (actual time=0.029..3.002 rows=1733 loops=1)"
"                                                        Filter: ((status IS NULL) OR (status = 0))"
"                                                        Rows Removed by Filter: 379"
"                                ->  Sort  (cost=1.36..1.38 rows=7 width=40) (actual time=0.091..0.099 rows=7 loops=1)"
"                                      Sort Key: payoffothers.payoff_id, payoffothers.contract_id"
"                                      Sort Method: quicksort  Memory: 25kB"
"                                      ->  HashAggregate  (cost=1.12..1.19 rows=7 width=24) (actual time=0.045..0.055 rows=7 loops=1)"
"                                            ->  Seq Scan on payoffothers  (cost=0.00..1.07 rows=7 width=24) (actual time=0.006..0.016 rows=7 loops=1)"
"                          ->  Hash  (cost=17.68..17.68 rows=768 width=8) (actual time=2.116..2.116 rows=768 loops=1)"
"                                Buckets: 1024  Batches: 1  Memory Usage: 30kB"
"                                ->  Seq Scan on payoffs  (cost=0.00..17.68 rows=768 width=8) (actual time=0.008..1.011 rows=768 loops=1)"
"                    ->  Hash  (cost=1.25..1.25 rows=25 width=112) (actual time=0.084..0.084 rows=25 loops=1)"
"                          Buckets: 1024  Batches: 1  Memory Usage: 2kB"
"                          ->  Seq Scan on organizations  (cost=0.00..1.25 rows=25 width=112) (actual time=0.005..0.036 rows=25 loops=1)"
"Total runtime: 7588.737 ms"
"""
}